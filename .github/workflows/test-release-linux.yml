name: Test HDFView Release - Linux

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'HDFView release tag (e.g., v3.4.1, snapshot)'
        type: string
        required: true
        default: 'snapshot'
      hdf4_version:
        description: 'HDF4 version used in release'
        type: string
        required: false
        default: '4.3.1'
      hdf5_version:
        description: 'HDF5 version used in release'
        type: string
        required: false
        default: '2.0.0'
  workflow_call:
    inputs:
      release_tag:
        description: 'HDFView release tag (e.g., v3.4.1, snapshot)'
        type: string
        required: true
      hdf4_version:
        description: 'HDF4 version used in release'
        type: string
        required: false
        default: '4.3.1'
      hdf5_version:
        description: 'HDF5 version used in release'
        type: string
        required: false
        default: '2.0.0'

permissions:
  contents: read

jobs:
  test-app-binary:
    name: Test App Binary (tar.gz)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Remove pre-installed Java and unset environment variables
        run: |
          echo "Unsetting Java environment variables..."
          unset JAVA_HOME
          unset JDK_HOME
          unset JRE_HOME
          unset CLASSPATH

          # Unset GitHub Actions Java setup variables (JAVA_HOME_<version>_<arch>)
          for var in $(env | grep '^JAVA_HOME_' | cut -d= -f1); do
            unset "$var"
            echo "Unset $var"
          done

          # Remove Java paths from PATH
          export PATH=$(echo "$PATH" | tr ':' '\n' | grep -v -E '(java|jdk|jre)' | tr '\n' ':' | sed 's/:$//')

          echo "Removing pre-installed Java directories..."
          sudo rm -rf /usr/lib/jvm

          echo "Java removed. Verifying:"
          java -version 2>&1 || echo "✓ Java not found (expected)"

          echo "Environment check:"
          echo "JAVA_HOME=${JAVA_HOME:-<not set>}"
          echo "PATH=${PATH}"

      - name: Download app binary from release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Downloading HDFView app binary from release: ${{ inputs.release_tag }}"
          gh release download ${{ inputs.release_tag }} \
            --repo $GITHUB_REPOSITORY \
            --pattern "HDFView-*App-Linux.tar.gz"

          echo "Downloaded files:"
          ls -lh HDFView-*.tar.gz

      - name: Extract app binary
        run: |
          echo "Extracting app binary..."
          tar -xzf HDFView-*App-Linux.tar.gz

          echo "App structure:"
          ls -lR HDFView/

      - name: Setup Xvfb and GTK
        run: |
          echo "Installing Xvfb and GTK for headless testing..."
          sudo apt-get update
          # sudo apt-get install -y xvfb libgtk-3-0
          sudo apt-get install -y xvfb

      - name: Run smoke test (launch app verification)
        run: |
          echo "Running smoke test: Launch HDFView and verify stability"

          echo "Starting Xvfb..."
          Xvfb :99 -screen 0 1024x768x24 &
          XVFB_PID=$!
          export DISPLAY=:99
          sleep 2

          echo "Attempting to launch HDFView..."

          # Find the launcher script
          if [ -f "HDFView/bin/HDFView" ]; then
            LAUNCHER="HDFView/bin/HDFView"
          else
            echo "✗ HDFView launcher not found at HDFView/bin/HDFView"
            kill $XVFB_PID 2>/dev/null || true
            exit 1
          fi

          echo "Found launcher at: $LAUNCHER"

          # Launch HDFView and let it run for 5 seconds, then kill it
          # If it crashes immediately, this will fail
          timeout 10s $LAUNCHER &
          APP_PID=$!
          sleep 5

          # Check if process is still running
          if ps -p $APP_PID > /dev/null 2>&1; then
            echo "✓ HDFView launched successfully and is running"
            kill $APP_PID 2>/dev/null || true
          else
            echo "✗ HDFView crashed or exited immediately"
            kill $XVFB_PID 2>/dev/null || true
            exit 1
          fi

          # Cleanup
          kill $XVFB_PID 2>/dev/null || true
          echo "✓ App binary smoke test PASSED"

      - name: Test Summary
        if: always()
        run: |
          echo "## App Binary Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Tag**: ${{ inputs.release_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **HDF4 Version**: ${{ inputs.hdf4_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **HDF5 Version**: ${{ inputs.hdf5_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Test**: Launch verification (5 second stability check)" >> $GITHUB_STEP_SUMMARY
          echo "- **Display**: Xvfb :99" >> $GITHUB_STEP_SUMMARY

  test-deb-installer:
    name: Test DEB Installer
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Remove pre-installed Java and unset environment variables
        run: |
          echo "Unsetting Java environment variables..."
          unset JAVA_HOME
          unset JDK_HOME
          unset JRE_HOME
          unset CLASSPATH

          # Unset GitHub Actions Java setup variables (JAVA_HOME_<version>_<arch>)
          for var in $(env | grep '^JAVA_HOME_' | cut -d= -f1); do
            unset "$var"
            echo "Unset $var"
          done

          # Remove Java paths from PATH
          export PATH=$(echo "$PATH" | tr ':' '\n' | grep -v -E '(java|jdk|jre)' | tr '\n' ':' | sed 's/:$//')

          echo "Removing pre-installed Java directories..."
          sudo rm -rf /usr/lib/jvm

          echo "Java removed. Verifying:"
          java -version 2>&1 || echo "✓ Java not found (expected)"

          echo "Environment check:"
          echo "JAVA_HOME=${JAVA_HOME:-<not set>}"
          echo "PATH=${PATH}"

      - name: Download DEB installer
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Downloading DEB installer from release: ${{ inputs.release_tag }}"
          gh release download ${{ inputs.release_tag }} \
            --repo $GITHUB_REPOSITORY \
            --pattern "HDFView-*-Linux.deb"

          echo "Downloaded installer:"
          ls -lh HDFView-*.deb

      - name: Install DEB package
        run: |
          echo "Creating directory for xdg-desktop-menu"
          mkdir /usr/share/desktop-directories

          echo "Updating apt cache..."
          sudo apt-get update

          echo "Installing DEB package..."
          sudo dpkg -i HDFView-*-Linux.deb || sudo apt-get install -f -y

          echo "Verifying installation..."
          dpkg -l | grep -i hdfview || echo "Package listing check"

      - name: Setup Xvfb
        run: |
          echo "Installing Xvfb and GTK for headless testing..."
          sudo apt-get update
          #sudo apt-get install -y xvfb libgtk-3-0
          sudo apt-get install -y xvfb

      - name: Verify installed application launches
        run: |
          echo "Starting Xvfb..."
          Xvfb :99 -screen 0 1024x768x24 &
          XVFB_PID=$!
          export DISPLAY=:99
          sleep 2

          echo "Attempting to launch installed HDFView..."

          # Try to find the installed launcher
          if [ -f "/opt/HDFView/bin/HDFView" ]; then
            LAUNCHER="/opt/HDFView/bin/HDFView"
          elif [ -f "/usr/bin/HDFView" ]; then
            LAUNCHER="/usr/bin/HDFView"
          else
            echo "Finding HDFView launcher..."
            LAUNCHER=$(find /opt /usr -name "HDFView" -type f 2>/dev/null | grep -i hdfview | head -1)
          fi

          if [ -z "$LAUNCHER" ]; then
            echo "✗ HDFView launcher not found after installation"
            kill $XVFB_PID 2>/dev/null || true
            exit 1
          fi

          echo "Found launcher at: $LAUNCHER"

          # Launch HDFView and let it run for 5 seconds, then kill it
          # If it crashes immediately, this will fail
          timeout 10s $LAUNCHER &
          APP_PID=$!
          sleep 5

          # Check if process is still running
          if ps -p $APP_PID > /dev/null 2>&1; then
            echo "✓ HDFView launched successfully and is running"
            kill $APP_PID 2>/dev/null || true
          else
            echo "✗ HDFView crashed or exited immediately"
            kill $XVFB_PID 2>/dev/null || true
            exit 1
          fi

          # Cleanup
          kill $XVFB_PID 2>/dev/null || true
          echo "✓ DEB installer smoke test PASSED"

      - name: Test Summary
        if: always()
        run: |
          echo "## DEB Installer Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Tag**: ${{ inputs.release_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **HDF4 Version**: ${{ inputs.hdf4_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **HDF5 Version**: ${{ inputs.hdf5_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Test**: Launch verification (5 second stability check)" >> $GITHUB_STEP_SUMMARY
          echo "- **Display**: Xvfb :99" >> $GITHUB_STEP_SUMMARY

  test-rpm-installer:
    name: Test RPM Installer
    runs-on: ubuntu-latest
    # Use Fedora container since GitHub doesn't provide native RPM-based runners
    container:
      image: fedora:latest
    timeout-minutes: 10

    steps:
      - name: Install dependencies
        run: |
          echo "Installing required packages in Fedora container..."
          dnf install -y \
            wget \
            procps-ng \
            findutils \
            xorg-x11-server-Xvfb \
            xorg-x11-xauth \
            gtk3 \
            metacity \
            dbus-daemon \
            dbus-x11 \
            mesa-libGL \
            fontconfig \
            xorg-x11-fonts-Type1 \
            xorg-x11-fonts-misc

      - name: Remove pre-installed Java and unset environment variables
        run: |
          echo "Unsetting Java environment variables..."
          unset JAVA_HOME
          unset JDK_HOME
          unset JRE_HOME
          unset CLASSPATH

          # Unset GitHub Actions Java setup variables (JAVA_HOME_<version>_<arch>)
          for var in $(env | grep '^JAVA_HOME_' | cut -d= -f1); do
            unset "$var"
            echo "Unset $var"
          done

          # Remove Java paths from PATH
          export PATH=$(echo "$PATH" | tr ':' '\n' | grep -v -E '(java|jdk|jre)' | tr '\n' ':' | sed 's/:$//')

          echo "Removing pre-installed Java directories..."
          rm -rf /usr/lib/jvm 2>/dev/null || echo "No Java found at /usr/lib/jvm"

          echo "Java removed. Verifying:"
          java -version 2>&1 || echo "✓ Java not found (expected)"

          echo "Environment check:"
          echo "JAVA_HOME=${JAVA_HOME:-<not set>}"
          echo "PATH=${PATH}"

      - name: Download RPM installer
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Downloading RPM installer from release: ${{ inputs.release_tag }}"

          # Install gh CLI in container (manual repo file creation for DNF 5 compatibility)
          echo '[gh-cli]' > /etc/yum.repos.d/gh-cli.repo
          echo 'name=GitHub CLI' >> /etc/yum.repos.d/gh-cli.repo
          echo 'baseurl=https://cli.github.com/packages/rpm' >> /etc/yum.repos.d/gh-cli.repo
          echo 'enabled=1' >> /etc/yum.repos.d/gh-cli.repo
          echo 'gpgcheck=0' >> /etc/yum.repos.d/gh-cli.repo
          dnf install -y gh

          gh release download ${{ inputs.release_tag }} \
            --repo $GITHUB_REPOSITORY \
            --pattern "HDFView-*-Linux.rpm"

          echo "Downloaded installer:"
          ls -lh HDFView-*.rpm

      - name: Install RPM package
        run: |
          echo "Installing RPM package..."
          # Skip %post scripts on github runner
          dnf install -y HDFView-*-Linux.rpm --setopt=tsflags=noscripts

          echo "Verifying installation..."
          rpm -qa | grep -i hdfview || echo "Package listing check"

      - name: Verify installed application launches
        run: |
          set -euo pipefail

          echo "=== Setting up complete headless environment for SWT ==="

          # Create DBus machine-id (required for SWT/GTK applications)
          echo "Creating DBus machine-id..."
          dbus-uuidgen > /var/lib/dbus/machine-id

          # Start Xvfb (X11 virtual framebuffer)
          echo "Starting Xvfb on :99..."
          export DISPLAY=:99
          Xvfb :99 -screen 0 1920x1080x24 -nolisten tcp &
          XVFB_PID=$!
          sleep 2

          # Verify X server is running
          echo "Verifying X server..."
          if ! xdpyinfo > /dev/null 2>&1; then
            echo "⚠ Warning: xdpyinfo failed, but continuing..."
          else
            echo "✓ X server is responding"
          fi

          # Start window manager (critical for SWT applications)
          echo "Starting metacity window manager..."
          metacity --sm-disable --replace &
          METACITY_PID=$!
          sleep 2

          echo "=== Headless environment ready ==="
          echo "Display: $DISPLAY"
          echo "Xvfb PID: $XVFB_PID"
          echo "Metacity PID: $METACITY_PID"

          # Find the installed HDFView launcher
          echo "=== Locating HDFView launcher ==="

          if [ -f "/opt/HDFView/bin/HDFView" ]; then
            LAUNCHER="/opt/HDFView/bin/HDFView"
          elif [ -f "/opt/hdfview/bin/HDFView" ]; then
            LAUNCHER="/opt/hdfview/bin/HDFView"
          elif [ -f "/usr/bin/HDFView" ]; then
            LAUNCHER="/usr/bin/HDFView"
          else
            echo "Searching for HDFView launcher..."
            LAUNCHER=$(find /opt /usr -name "HDFView" -type f 2>/dev/null | grep -i hdfview | head -1)
          fi

          if [ -z "$LAUNCHER" ]; then
            echo "✗ HDFView launcher not found after installation"
            kill $METACITY_PID 2>/dev/null || true
            kill $XVFB_PID 2>/dev/null || true
            exit 1
          fi

          echo "✓ Found launcher at: $LAUNCHER"

          # Launch HDFView and verify it stays running
          echo "=== Testing HDFView launch ==="
          echo "Launching HDFView (will run for 5 seconds)..."

          timeout 10s $LAUNCHER &
          APP_PID=$!
          sleep 5

          # Check if process is still running
          if ps -p $APP_PID > /dev/null 2>&1; then
            echo "✓ HDFView launched successfully and is running"
            kill $APP_PID 2>/dev/null || true
          else
            echo "✗ HDFView crashed or exited immediately"
            kill $METACITY_PID 2>/dev/null || true
            kill $XVFB_PID 2>/dev/null || true
            exit 1
          fi

          # Cleanup
          echo "=== Cleaning up ==="
          kill $METACITY_PID 2>/dev/null || true
          kill $XVFB_PID 2>/dev/null || true

          echo ""
          echo "✓ RPM installer smoke test PASSED"
          echo "✓ HDFView successfully launched in headless Fedora environment"

      - name: Test Summary
        if: always()
        run: |
          echo "## RPM Installer Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Tag**: ${{ inputs.release_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **HDF4 Version**: ${{ inputs.hdf4_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **HDF5 Version**: ${{ inputs.hdf5_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Test**: Launch verification (5 second stability check)" >> $GITHUB_STEP_SUMMARY
          echo "- **Display**: Xvfb :99 (in Fedora container)" >> $GITHUB_STEP_SUMMARY
          echo "- **Container**: fedora:latest" >> $GITHUB_STEP_SUMMARY
