name: Test HDFView Release - macOS

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'HDFView release tag (e.g., HDFView-3.4.0, snapshot)'
        type: string
        required: true
        default: 'snapshot'
      architecture:
        description: 'Architecture (x86_64 or arm64)'
        type: choice
        options:
          - x86_64
          - arm64
        default: 'arm64'
      hdf4_version:
        description: 'HDF4 version used in release'
        type: string
        required: false
        default: '4.3.1'
      hdf5_version:
        description: 'HDF5 version used in release'
        type: string
        required: false
        default: '2.0.0'
  workflow_call:
    inputs:
      release_tag:
        description: 'HDFView release tag (e.g., HDFView-3.4.0, snapshot)'
        type: string
        required: true
      architecture:
        description: 'Architecture (x86_64 or arm64)'
        type: string
        required: false
        default: 'arm64'
      hdf4_version:
        description: 'HDF4 version used in release'
        type: string
        required: false
        default: '4.3.1'
      hdf5_version:
        description: 'HDF5 version used in release'
        type: string
        required: false
        default: '2.0.0'

permissions:
  contents: read

jobs:
  test-app-binary:
    name: Test App Binary (tar.gz)
    runs-on: ${{ inputs.architecture == 'x86_64' && 'macos-15-intel' || 'macos-15' }}  # macos-15-intel=x86_64, macos-15=arm64
    timeout-minutes: 15

    steps:
      - name: Remove pre-installed Java and unset environment variables
        run: |
          echo "Unsetting Java environment variables..."
          unset JAVA_HOME
          unset JDK_HOME
          unset JRE_HOME
          unset CLASSPATH

          # Unset GitHub Actions Java setup variables (JAVA_HOME_<version>_<arch>)
          for var in $(env | grep '^JAVA_HOME_' | cut -d= -f1); do
            unset "$var"
            echo "Unset $var"
          done

          # Remove Java paths from PATH
          export PATH=$(echo "$PATH" | tr ':' '\n' | grep -v -E '(java|jdk|jre)' | tr '\n' ':' | sed 's/:$//')

          echo "Removing pre-installed Java directories..."
          sudo rm -rf /Library/Java/JavaVirtualMachines
          sudo rm -rf /System/Library/Java
          sudo rm -rf ~/Library/Java

          echo "Java removed. Verifying:"
          java -version 2>&1 || echo "✓ Java not found (expected)"

          echo "Environment check:"
          echo "JAVA_HOME=${JAVA_HOME:-<not set>}"
          echo "PATH=${PATH}"

      - name: Download app binary from release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Downloading HDFView app binary from release: ${{ inputs.release_tag }}"
          gh release download ${{ inputs.release_tag }} \
            --repo $GITHUB_REPOSITORY \
            --pattern "HDFView-*App-Darwin-${{ inputs.architecture }}.tar.gz"

          echo "Downloaded files:"
          ls -lh HDFView-*.tar.gz

      - name: Extract app binary
        run: |
          echo "Extracting app binary..."
          tar -xzf HDFView-*App-Darwin-*.tar.gz

          echo "App structure:"
          ls -lR HDFView.app/

      # NOTE: The way that JUnit UI tests use threads is currently incompatible with macOS.
      # Pending a major refactor to the test setup, just run the app directly.
      # See: AbstractWindowTest creates Display in a separate thread, violating macOS Cocoa
      # requirement that Display must be created on the main thread (-XstartOnFirstThread).

      - name: Run smoke test (launch app verification)
        run: |
          echo "Running smoke test: Launch HDFView and verify stability"
          echo "macOS GitHub runners have VMware display emulation built-in"

          # Check for quarantine attribute (macOS security)
          echo "Checking quarantine attribute..."
          xattr HDFView.app || echo "No extended attributes"

          # Remove quarantine attribute if present (needed for testing)
          echo "Removing quarantine attribute for testing..."
          xattr -dr com.apple.quarantine HDFView.app 2>/dev/null || echo "No quarantine to remove"

          # Try to launch the application briefly
          echo "Launching HDFView for stability check..."
          open HDFView.app &
          APP_PID=$!

          # Wait 5 seconds to see if it crashes
          sleep 5

          # Check if the app is still running
          # Look for the actual process (not the 'open' command)
          if pgrep -f "HDFView.app" > /dev/null; then
            echo "✓ HDFView launched successfully and is running"

            # Kill the app
            pkill -f "HDFView.app" || killall HDFView 2>/dev/null || true

            echo "✓ App binary smoke test PASSED"
          else
            echo "✗ HDFView crashed or exited immediately"

            # Check system logs for crash info
            echo "Checking for crash logs..."
            ls -la ~/Library/Logs/DiagnosticReports/HDFView* 2>/dev/null || echo "No crash logs found"

            exit 1
          fi

      - name: Test Summary
        if: always()
        run: |
          echo "## App Binary Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Tag**: ${{ inputs.release_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Architecture**: ${{ inputs.architecture }}" >> $GITHUB_STEP_SUMMARY
          echo "- **HDF4 Version**: ${{ inputs.hdf4_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **HDF5 Version**: ${{ inputs.hdf5_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Test**: Launch verification (5 second stability check)" >> $GITHUB_STEP_SUMMARY
          echo "- **Display**: VMware display emulation (built-in)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Note: JUnit UI tests are currently incompatible with macOS threading model_" >> $GITHUB_STEP_SUMMARY

  test-dmg-installer:
    name: Test DMG Installer
    runs-on: ${{ inputs.architecture == 'x86_64' && 'macos-15-intel' || 'macos-15' }}  # macos-15-intel=x86_64, macos-15=arm64
    timeout-minutes: 10

    steps:
      - name: Remove pre-installed Java and unset environment variables
        run: |
          echo "Unsetting Java environment variables..."
          unset JAVA_HOME
          unset JDK_HOME
          unset JRE_HOME
          unset CLASSPATH

          # Unset GitHub Actions Java setup variables (JAVA_HOME_<version>_<arch>)
          for var in $(env | grep '^JAVA_HOME_' | cut -d= -f1); do
            unset "$var"
            echo "Unset $var"
          done

          # Remove Java paths from PATH
          export PATH=$(echo "$PATH" | tr ':' '\n' | grep -v -E '(java|jdk|jre)' | tr '\n' ':' | sed 's/:$//')

          echo "Removing pre-installed Java directories..."
          sudo rm -rf /Library/Java/JavaVirtualMachines
          sudo rm -rf /System/Library/Java
          sudo rm -rf ~/Library/Java

          echo "Java removed. Verifying:"
          java -version 2>&1 || echo "✓ Java not found (expected)"

          echo "Environment check:"
          echo "JAVA_HOME=${JAVA_HOME:-<not set>}"
          echo "PATH=${PATH}"

      - name: Download DMG installer
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Downloading DMG installer from release: ${{ inputs.release_tag }}"
          gh release download ${{ inputs.release_tag }} \
            --repo $GITHUB_REPOSITORY \
            --pattern "HDFView-*-Darwin-${{ inputs.architecture }}.dmg"

          echo "Downloaded installer:"
          ls -lh HDFView-*.dmg

      - name: Mount and install DMG
        run: |
          echo "Mounting DMG..."
          dmgFile=$(ls HDFView-*.dmg | head -1)

          # Mount the DMG
          hdiutil attach "$dmgFile" -mountpoint /Volumes/HDFView

          echo "DMG mounted successfully"
          ls -la /Volumes/HDFView/

          # Copy app to Applications (simulating user installation)
          echo "Installing HDFView.app to /Applications..."
          cp -R /Volumes/HDFView/HDFView.app /Applications/

          # Unmount
          echo "Unmounting DMG..."
          hdiutil detach /Volumes/HDFView

          echo "Installation complete"

      - name: Verify installation and launch test
        run: |
          echo "Verifying installation..."

          if [ ! -d "/Applications/HDFView.app" ]; then
            echo "✗ Installation not found at /Applications/HDFView.app"
            exit 1
          fi

          echo "✓ Installation found at /Applications/HDFView.app"

          # Check for quarantine attribute (macOS security)
          echo "Checking quarantine attribute..."
          xattr /Applications/HDFView.app || echo "No extended attributes"

          # Remove quarantine attribute if present (needed for unsigned apps in testing)
          echo "Removing quarantine attribute for testing..."
          xattr -dr com.apple.quarantine /Applications/HDFView.app 2>/dev/null || echo "No quarantine to remove"

          # Try to launch the application briefly
          echo "Launching HDFView for stability check..."
          open /Applications/HDFView.app &
          APP_PID=$!

          # Wait 5 seconds to see if it crashes
          sleep 5

          # Check if the app is still running
          # Look for the actual process (not the 'open' command)
          if pgrep -f "HDFView.app" > /dev/null; then
            echo "✓ HDFView launched successfully and is running"

            # Kill the app
            pkill -f "HDFView.app" || killall HDFView 2>/dev/null || true

            echo "✓ DMG installer smoke test PASSED"
          else
            echo "✗ HDFView crashed or exited immediately"

            # Check system logs for crash info
            echo "Checking for crash logs..."
            ls -la ~/Library/Logs/DiagnosticReports/HDFView* 2>/dev/null || echo "No crash logs found"

            exit 1
          fi

      - name: Test Summary
        if: always()
        run: |
          echo "## DMG Installer Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Tag**: ${{ inputs.release_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Architecture**: ${{ inputs.architecture }}" >> $GITHUB_STEP_SUMMARY
          echo "- **HDF4 Version**: ${{ inputs.hdf4_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **HDF5 Version**: ${{ inputs.hdf5_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Test**: Launch verification (5 second stability check)" >> $GITHUB_STEP_SUMMARY
          echo "- **Display**: VMware display emulation (built-in)" >> $GITHUB_STEP_SUMMARY
